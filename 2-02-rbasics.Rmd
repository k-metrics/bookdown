# Rの基本
**R**の文法説明が延々と続いてもつまらないので、本書では少し実用的な面から**R**のプログラミングを説明します。本チャプターでは『統計のはなし【改訂版】』`r if (knitr::is_latex_output())'[@ToukeinoHanashi]'`や『統計解析のはなし【改訂版】』`r if (knitr::is_latex_output())'[@ToukeiKaisekinoHanashi]'`を参考書として説明します。個々の詳細については、これらの書籍などを参照してください。
なお、基本文法については[Appendix R Basics](#Appendix-RBasics)をご覧ください。


## 要約統計量
データを分析する前には分析対象となるデータがどのような特徴を持っているか確認しておくことが重要であるとよく言われます。この特徴を見るには要約統計量を使う場合が多いです。要約統計量はデータの分布の特徴を表すもので、記述統計量や基本統計量と呼ばれることもあります。


### 平均
算術平均（相加平均）は要約統計量の中でよく使われ、下式で求められます。
<!-- $$\bar{x} = \frac{x_1 + x_2 + \cdots + x_n}{n} = \frac{1}{n} \sum_{i = 1}^n x_i$$ -->

\begin{equation}
  \bar{x} = \frac{x_1 + x_2 + \cdots + x_n}{n} = \frac{1}{n} \sum_{i = 1}^n x_i
\end{equation}

算術平均以外にも幾何平均（相乗平均）や
<!-- $$\sqrt[n]{x_1 \times x_2 \times \cdots \times x_n} = \sqrt[n]{\prod_{i = 1}^n x_i}$$ -->
\begin{equation}
  \sqrt[n]{x_1 \times x_2 \times \cdots \times x_n} = \sqrt[n]{\prod_{i = 1}^n x_i}
\end{equation}

体操競技などで使われる得点の最小値と最大値を除いた得点の平均であるトリム平均などがあります。平均といってもこのように様々な求め方があります。では、**R**を使ってこれらの平均を求めてみます。

以降、灰色に網掛けされた部分が**R**のコード、コードの下の`##`で始まる部分が実行結果（出力）になります。コードによっては実行結果が出力されない場合もあります。


#### 算術平均
算術平均は`mean()`関数で求めることができます。最初に平均の計算対象となるデータ（変数）を`c()`関数で作成します。`c()`関数はベクトル型の変数を作成する関数です。

```{r}
x <- c(1, 3, 3, 5, 7)
```

`x`は値を代入（格納）する変数、`<-`は代入演算子（**R**では代入に`=`は使わないのが基本です）、`c()`関数はベクトルデータを作成する関数です。代入結果を確認するには以下を実行します。


```{r}
x
```

算出平均は`mean()`関数に計算対象となる`x`を指定して実行します。

```{r}
mean(x)
```


#### トリム平均
トリム平均は算術平均のコードに`trim`オプションを指定するだけです。`trim`オプションは計算対象外にする割合を指定するオプションです。今回は五つのデータから最小値・最大値の二つを除いてトリム平均を求めますので$\frac{2}{5} = 0.2$を指定します。

```{r}
mean(x, trim = 0.2)
```

関数に指定できるオプションを確認した場合場`?`に続いて関数名を`()`付きで打ち込んで実行してください。ヘルプが表示されます。

```{r, eval=FALSE}
?mean()
```


#### 幾何平均
幾何平均（相乗平均）を求める関数は標準では用意されていません。パッケージを追加インストールする必要があります。ここでは**`psych`**パッケージを下記の手順でインストールして使います。なお、インストールに際してはインターネット接続が必要です。

1. パッケージをインストールする
1. パッケージを読み込む

パッケージのインストールは`install.packages()`関数を用います。`install.packages()`関数を実行すると環境によってはCRANミラーサイトの選択を促される場合があります。その場合は、最も近い地域のミラーサイトを選択してください。なお、パッケージのインストールは一度行えば次からのインストールは不要です。

```{r, eval=FALSE}
install.packages("psych")
```

インストールが完了しましたら`library()`関数を使ってパッケージを読み込みます。

```{r}
library(psych)
```

環境によっては上記のように他のパッケージの関数をマスクしている旨のメッセージが出力されますが、今は気にする必要ありません。

これで**`psych`**パッケージを使う準備が整いましたので、`geometric.mean()`関数で幾何平均を求めます。

```{r}
geometric.mean(x)
```

インストールしたパッケージの関数を使う場合、どのパッケージの関数を使っているかを明示的に示すために下記のように`::`演算子（名前空間へのアクセス演算子という）でパッケージ名と関数名をつなげて記述することもできます。

```{r}
psych::geometric.mean(x)
```

この表記方法については賛否ありますが、どのパッケージの関数を使っているかが分かりやすいので本書ではこの記述方法を用います。


#### 閑話 {.unnumbered}
幾何平均を求めるために`psych`パッケージを利用しましたが、**R**には総積（$x_1 \times x_2 \times \cdots \times x_n$）を求める`prod()`関数と累乗根（$x^{\frac{1}{n}}$）を求めるべき乗演算子（`^`）がありますので、これを組み合わせれば幾何平均を求めることが可能です。

```{r}
prod(x)^(1/length(x))
```

`length()`関数は変数`x`の長さ（変数`x`の中にある値の個数）を求める関数です。ただし、この計算には注意が必要です。

幾何平均は全ての値を`prod()`関数で乗算しますので、データの数が多い場合やデータの値が大きい（または、小さい）場合に`prod()`関数がオーバーフロー（または、アンダーフロー）を起こしてしまうことがあります。例えば、$1$から$200$までを乗算するだけでオーバーフローを起こしてしまいます。

```{r}
prod(c(1:200))
```

一方、`geometric.mean()`関数はフロー対策が施されていますのでオーバーフローを起こすことなく幾何平均を求めることができます。

```{r}
psych::geometric.mean(c(1:200))
```

このように既にパッケージとして提供されている関数があれば、自分でコードを組むよりはパッケージを導入した方が早くて確実です（ここでの本来の目的は幾何平均を求めることでなくデータの特徴を掴むことです）。特に**CRAN**に登録されているパッケージは審査が行われていますので、使わないよりは使った方が確実に目的を達成しやすくなります。**R**には先人の知恵が結集していますので、車輪の再発明に挑戦するより先人の知恵を活用する方をおすゝめします。


### 分散・標準偏差
データの散らばり具合を見るには分散・標準偏差がよく使われます。例えば、以下の`x`と`y`が取る値の範囲は同一ですが、同じ散らばり具合と言えるでしょうか？

```{r}
x <- c(1, 5, 5, 5, 9)
range(x)
y <- c(1, 1, 5, 9, 9)
range(y)
```

散らばり具合を見るためにデータの個々の値と平均値との差の二乗の算術平均を分散（標本分散$s^2$）、

<!-- $$s^2 = \frac{1}{n} \sum_{i = 1}^n (x_i - \bar{x})^2$$￥ -->
<!-- $$s = \sqrt{s^2} = \sqrt{\frac{1}{n} \sum_{i = 1}^n (x_i - \bar{x})^2}$$ -->
\begin{equation}
  s^2 = \frac{1}{n} \sum_{i = 1}^n (x_i - \bar{x})^2
  \label{eq:variance}
\end{equation}

単位を戻すために分散の平方根をとったものを標準偏差（標本標準偏差$s$）と呼びます。

\begin{equation}
  s = \sqrt{s^2} = \sqrt{\frac{1}{n} \sum_{i = 1}^n (x_i - \bar{x})^2}
\end{equation}

しかし、**R**にはこの標本分散（$s^2$）を求める関数は用意されていませんが、不偏分散（$\hat{\sigma}^2$）を求める`var()`関数が用意されています。

<!-- $$\hat{\sigma}^2 = \frac{1}{n - 1} \sum_{i = 1}^n (x_i - \bar{x})^2 = var(x)$$ -->
\begin{equation}
  \hat{\sigma}^2 = \frac{1}{n - 1} \sum_{i = 1}^n (x_i - \bar{x})^2 = var(x)
  \label{eq:var}
\end{equation}

標本分散（$s^2$）の定義式`r if (knitr::is_latex_output())'\\@ref(eq:variance)'`と不偏分散（$\hat{\sigma}^2$）の定義式`r if (knitr::is_latex_output())'\\@ref(eq:var)'`から標本分散（$s^2$）と不偏分散（$\hat{\sigma}^2$）の間には関係があることが分かります。

<!-- $$s^2 = \frac{n - 1}{n}\hat{\sigma}^2$$ -->
\begin{equation}
  s^2 = \frac{n - 1}{n}\hat{\sigma}^2
  \label{eq:variance-var}
\end{equation}

<!-- 母分散（$\sigma^2$）これは分からない -->

<!-- 標本分散（$s^2$） 標本から求められる -->

<!-- 母分散の不偏推定量（$\hat{\sigma}^2$）不偏標本分散・不偏分散ともいい、標本から推定する -->


#### 演習 1 {.unnumbered}
標本分散（$s^2$）と不偏分散（$\hat{\sigma}^2$）の関係式`r if (knitr::is_latex_output())'\\@ref(eq:variance-var)'`を用いて**R**で以下の二つのデータの標本分散を求めなさい。

```{r}
x <- c(1, 5, 5, 5, 9)
y <- c(1, 1, 5, 9, 9)
```


#### 演習 2 {.unnumbered}
欠損値を含む以下のデータの平均値（$\bar{x}$）、不偏分散（$\hat{\sigma}^2$）ならびに標本分散（$s^2$）を求めなさい。

```{r}
z <- c(1, 5, NA, 7, 9)
```

> ヒント：`na.rm`オプションを使います


#### 閑話 {.unnumbered}
平均（分布の重心）と分散（分布の広がり）は、歪度（分布の左右非対称度合い）、尖度（分布の峰の尖り度合い）を含めて「モーメントから求められる要約統計量」と言われることがあります。
n個のデータの平均値を

$$\bar{x} = \frac{1}{n}\sum_{i = 1}^{n}x_i$$
\begin{equation}
\end{equation}

とした場合、平均値まわりの$m$次の中央モーメント$\bar{x}_m$を

$$\bar{x}_m = \frac{1}{n}\sum_{i = 1}^{n}(x_i - \bar{x})^m　　(m = 2, 3, 4)$$
\begin{equation}
\end{equation}

と定義します。$m = 2$の場合、

$$\bar{x}_2 = \frac{1}{n}\sum_{i = 1}^{n}(x_i - \bar{x})^2 = s^2$$
\begin{equation}
\end{equation}

となりますので、$\bar{x}_2$は分散$s^2$であることがわかります。$m = 3$の場合、

$$\bar{x}_3 = \frac{1}{n}\sum_{i = 1}^{n}(x_i - \bar{x})^3$$
\begin{equation}
\end{equation}

となり、これを標準偏差の三乗（$s^3$）で割ったもの

$$\gamma_1 = \frac{\bar{x}_3}{s^3}$$
\begin{equation}
\end{equation}

を歪度（$\gamma_1$）と呼びます。$m = 4$の場合、

$$\bar{x}_4 = \frac{1}{n}\sum_{i = 1}^{n}(x_i - \bar{x})^4$$
\begin{equation}
\end{equation}

となり、これを標準偏差の四乗、または、分散の二乗（$s^4$）で割ったもの

<!-- $$\gamma_2 = \frac{\bar{x}_4}{s^4}$$ -->
\begin{equation}
  \gamma_2 = \frac{\bar{x}_4}{s^4}
\end{equation}

を尖度（$\gamma_2$）と呼びます。


#### 【コラム】英文字？ギリシャ文字？ {.unnumbered}
<!-- 平均は$\bar{x}$と記すのか$\hat{\mu}$と記すのか？ -->
統計では様々な統計量を英語で表記する場合とギリシャ語で表記する場合があり混乱しやすいのですが、統計量を英語で表記されている場合は（標本）統計量、ギリシャ語で表記されている場合は母数の推定統計量（推定量）を意味しています。推定量を表記する場合、推定量であることを意味するハット（$\hat{}$）という記号をつけて表記します（例えば、平均値は$\hat{\mu}$、分散は$\hat{\sigma}^2$と表記）。ハット（$\hat{}$）を省略している書籍や資料も散見されますので混乱しないように注意してください。詳しくは『統計的方法のしくみ』`r if(knitr::is_latex_output())'[@ToukeitekiHouhounoSikumi:jbook]'`の「3. 母数と統計量の区別」[@ToukeitekiHouhounoSikumi:jbook]を参照してください。



### 中央値
平均値や分散・標準偏差

平均値と並んで比較的よく使われるのが中央値です。中央値はデータの分布が歪んでいる場合に使われることが多いように比較的ロバスト（データの分布に左右されにくい）な統計量です。
中央値
```{r}
x
median(x)
```


### 最小・最大値
```{r}
x
min(x)
max(x)
```

**R**には`range()`関数という最小値を最大値を一度に求めることができる便利な関数があります。
```{r}
x
range(x)
```


### レンジ（範囲）
データのばらつきを見るためにレンジと呼ばれる範囲を用いることがあります。以下の`x`と`y`は同じ平均値をとるデータです。
```{r}
x <- c(2, 2, 5, 8, 8)
mean(x)
y <- c(1, 5, 5, 5, 9)
mean(y)
```

レンジを求めるには`range()`関数を用います。
```{r}
range(x)
range(y)
```

`range()`関数は最小値と最大値を求める関数ですので`diff()`関数を用いて最小値と最大値の幅を求めます。
```{r}
diff(range(x))
diff(range(y))
```




### 最頻値
最頻値とはデータの中で最も頻繁に出てくる値のことで、モードとも呼ばれます。最頻値を求める関数は標準では用意されていませんので`modeest`パッケージを用います。
```{r, eval=FALSE}
install.packages("modeest")
```

```{r}
library(modeest)
```

```{r}
modeest::mfv(x)
modeest::mfv(y)
```


