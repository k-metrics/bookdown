# **R**の基本
**R**の文法説明が延々と続いてもつまらないので、本書では少し実用的な面から**R**のプログラミングを説明します。本チャプターでは『統計のはなし【改訂版】』[@ToukeinoHanashi]や『統計解析のはなし【改訂版】』[@ToukeiKaisekinoHanashi]を参考書として説明します。個々の詳細については、これらの書籍などを参照してください。
なお、基本文法については[Appendix R Basics](#Appendix-RBasics)をご覧ください。


## 基本統計量
データを分析する前には対象となるデータがどのような特徴を持っているか確認しておくことが重要であるとよく言われます。データの特徴を見るには基本統計量を用いる分かりやすいと思います。


### 平均
統計量の中でよく使われるのが平均です。平均というと下式で表される算術平均を思い浮かべる方が多いと思いますが、
$$\bar{x} = \frac{x_1 + x_2 + \cdots + x_n}{n} = \frac{1}{n} \sum_{i = 1}^n x_i$$
算術平均以外にも下式で表される幾何平均（相乗平均）や
$$\sqrt[n]{x_1 \times x_2 \times \cdots \times x_n} = \sqrt[n]{\prod_{i = 1}^n x_i}$$
体操競技などで使われる複数審判が出す得点の最小値と最大値を除いた得点の平均であるトリム平均などがあります。以降、灰色に網掛けされた部分が**R**のコード、コードの下の`##`で始まる部分が実行結果ですので、コード部分をコピペして**R**のコンソールで実行してみてください。

**R**では算術平均とトリム平均は`mean()`関数で求めることができます。最初に平均の計算対象となるデータを作成します。
```{r}
x <- c(1, 3, 3, 5, 7)
```

ここで`x`は5つの値を格納（代入）するための変数、`<-`は値を変数に格納するための代入演算子、`c()`関数はベクトルデータを作成する関数です。代入結果を確認するには以下を実行します。
```{r}
x
```

算出平均は`mean()`関数に計算対象である`x`を指定します。
```{r}
mean(x)
```


トリム平均は上記のコードに`trim`オプションを指定します。`trim`オプションは計算対象外にする割合を指定するオプションです。今回は五つのデータから最小値・最大値の二つを除いてトリム平均を求めるので$\frac{2}{5} = 0.2$を指定します。
```{r}
mean(x, trim = 0.2)
```

ヘルプを見たい場合は`?`に続いて関数名を`()`付きで打ち込んで実行してください。
```{r, eval=FALSE}
?mean()
```



幾何平均を求める関数は標準では用意されていませんのでインストールする必要があり、ここでは**`psych`**パッケージを使います。パッケージをインストールして使えるようにするには以下の手順が必要です。

1. パッケージをインストールする
1. パッケージを読み込む

パッケージのインストールは`install.packages()`関数を用います。インターネットに接続している必要があります。`install.packages()`関数を実行すると環境によってはCRANミラーサイトの選択を促される場合があります。その場合は、お住まいの地域に最も近い地域のミラーサイトを選択してください。なお、パッケージのインストールは一度だけでよく、次からはインストール不要になります。
```{r, eval=FALSE}
install.packages("psych")
```

インストールが完了したらパッケージが提供する関数などを使えるように`library()`関数を使ってパッケージを使えるようにします。
```{r}
library(psych)
```

環境によっては上記のように他のパッケージの関数をマスクしている旨のメッセージが出力されてますが、今は、あまり気にする必要はありません。
これで**`psych`**パッケージを使う準備が整いましたので、`geometric.mean()`関数で幾何平均を求めます。
```{r}
geometric.mean(x)
```

インストールしたパッケージの関数を使う場合、どのパッケージの関数を使っているかを明示的に示すために下記のように`::`演算子（名前空間へのアクセス演算子）でパッケージ名と関数名をつなげて記述することもできます。
```{r}
psych::geometric.mean(x)
```

この表記方法については賛否ありますが、どのパッケージの関数を使っているかを明示できるので、本書ではこの記述方法を用います。


ところで、この程度の幾何平均であればパッケージをインストールしなくても総積を求める`prod()`関数とべき乗演算子（`^`）を使えば計算は可能です、
```{r}
prod(x)^(1/5)
```
ただし、幾何平均ではデータの値を全て乗算しなければならないためデータ数が多い場合や値が大きい（または、小さい）場合に`prod()`関数でオーバーフロー（または、アンダーフロー）が起こるという問題があります。
```{r}
prod(c(1:200))
```

一方、`geometric.mean()`関数ではオーバーフロー（または、アンダーフロー）対策が施されていますので正しい値を求めることができます。
```{r}
psych::geometric.mean(c(1:200))
```

つまり、パッケージ、特にCRANに登録されているパッケージは登録にあたり審査による検証が行われていますので、使わないより使う方が楽で確実なことが多いのです。


### 中央値
平均値と並んで比較的よく使われるのが中央値です。中央値はデータの分布が歪んでいる場合に使われることが多いように比較的ロバスト（データの分布に左右されにくい）な統計量です。
中央値
```{r}
x
median(x)
```


### 最小・最大値
```{r}
x
min(x)
max(x)
```

**R**には`range()`関数という最小値を最大値を一度に求めることができる便利な関数があります。
```{r}
x
range(x)
```


### レンジ（範囲）
データのばらつきを見るためにレンジと呼ばれる範囲を用いることがあります。以下の`x`と`y`は同じ平均値をとるデータです。
```{r}
x <- c(2, 2, 5, 8, 8)
mean(x)
y <- c(1, 5, 5, 5, 9)
mean(y)
```

レンジを求めるには`range()`関数を用います。
```{r}
range(x)
range(y)
```

`range()`関数は最小値と最大値を求める関数ですので`diff()`関数を用いて最小値と最大値の幅を求めます。
```{r}
diff(range(x))
diff(range(y))
```


### 標準偏差
レンジは比較的簡単に計算できますが、以下のように同じレンジを持つデータの特徴が同じと言えるでしょうか？
```{r}
x <- c(1, 5, 5, 5, 9)
range(x)
y <- c(1, 1, 5, 9, 9)
range(y)
```


母分散（$\sigma^2$）これは分からない

標本分散（$s^2$） 標本から求められる

母分散の不偏推定量（$\hat{\sigma}^2$）不偏標本分散・不偏分散ともいい、標本から推定する



このような場合、下式で求められる標準偏差（Standard Deviation）を使うと特徴が見えてくることがあります。

$$S = \sqrt{\frac{1}{n} \sum_{i = 1}^n (x_i - \bar{x})^2} = \sqrt{\frac{\sum_{i = 1}^{n}x_{i}^2}{n} - \bar{x}^2 }$$

**R**に標準で用意されている`sd()`関数は不偏標準偏差を求める関数です。
$$s = \sqrt{\frac{1}{n - 1} \sum_{i = 1}^n (x_i - \bar{x})^2} = \sqrt{\frac{\sum_{i = 1}^{n}x_{i}^2}{n - 1} - \bar{x}^2 }$$

標本標準偏差（$\sigma$）を求めるには不偏分散（$s^2$）を求める`var()`関数を用いて標本分散（$\sigma^2$）を求めた後に平方根（$\sqrt{}$）を取ります。データの長さ（$n$）を求める関数は`length()`関数ですので標本分散は以下の通りとなります。

$$s^2 = \frac{n - 1}{n}\hat{\sigma}^2 = \frac{length(x) - 1}{length(x)}var(x)$$

```{r}
variance <- function(x) {
  n <- length(x)
  return ((n - 1) / n * var(x))
}


var(x)
variance(x)

sd(x)
sd(y)
```

> 演習  
> `x`に`NA`が含まれる場合、`var()`関数では`na.rm = TRUE`オプションを指定すれば`NA`を除いて計算してくれます。これを踏まえて上で定義している`variance()`関数の引数に`na.rm`オプションを追加して`NA`が含まれている場合でも標本分散を求められるように改修してください。  
> 　  
> `variance <- function(x, na.rm = FALSE) {...}`

<!-- variance <- function(x, na.rm = FALSE) { -->
<!--   if (na.rm = TRUE) { -->
<!--     n <- sum(!is.na(x)) -->
<!--   } else { -->
<!--     n <- length(x) -->
<!--   } -->
<!--   return ((n - 1) / n * var(x, na.rm)) -->
<!-- } -->


### 最頻値
最頻値とはデータの中で最も頻繁に出てくる値のことで、モードとも呼ばれます。最頻値を求める関数は標準では用意されていませんので`modeest`パッケージを用います。
```{r, eval=FALSE}
install.packages("modeest")
```

```{r}
library(modeest)
```

```{r}
modeest::mfv(x)
modeest::mfv(y)
```


